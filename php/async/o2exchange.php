<?php

namespace ccxt\async;

// PLEASE DO NOT EDIT THIS FILE, IT IS GENERATED AND WILL BE OVERWRITTEN:
// https://github.com/ccxt/ccxt/blob/master/CONTRIBUTING.md#how-to-contribute-code

use Exception; // a common import
use ccxt\async\abstract\o2exchange as Exchange;
use ccxt\Precise;
use \React\Async;
use \React\Promise\PromiseInterface;

class o2exchange extends Exchange {

    public function describe(): mixed {
        return $this->deep_extend(parent::describe(), array(
            'id' => 'o2exchange',
            'name' => 'O2 Exchange',
            'countries' => array( 'US' ),
            'version' => 'v1',
            'rateLimit' => 100,
            'certified' => false,
            'pro' => false,
            'dex' => true,
            'has' => array(
                'CORS' => null,
                'spot' => true,
                'margin' => false,
                'swap' => false,
                'future' => false,
                'option' => false,
                // Public API
                'fetchMarkets' => true,
                'fetchTicker' => true,
                'fetchTickers' => false,
                'fetchOrderBook' => true,
                'fetchTrades' => true,
                'fetchOHLCV' => true,
                // Private API (to implement later)
                'fetchBalance' => false,
                'createOrder' => false,
                'cancelOrder' => false,
                'fetchOpenOrders' => false,
                'fetchClosedOrders' => false,
                'fetchMyTrades' => false,
            ),
            'timeframes' => array(
                '1m' => '1',
                '5m' => '5',
                '15m' => '15',
                '30m' => '30',
                '1h' => '60',
                '4h' => '240',
                '1d' => '1440',
            ),
            'urls' => array(
                'logo' => 'https://o2.app/logo.png',
                'api' => array(
                    'public' => 'https://api.o2.app',
                    'private' => 'https://api.o2.app',
                ),
                'test' => array(
                    'public' => 'https://api.testnet.o2.app',
                    'private' => 'https://api.testnet.o2.app',
                ),
                'www' => 'https://o2.app',
                'doc' => array(
                    'https://docs.o2.app',
                ),
            ),
            'api' => array(
                'public' => array(
                    'get' => array(
                        'v1/markets' => 1,
                        'v1/markets/summary' => 1,
                        'v1/markets/ticker' => 1,
                        'v1/depth' => 1,
                        'v1/trades' => 1,
                        'v1/bars' => 1,
                        'health' => 1,
                    ),
                ),
                'private' => array(
                    'get' => array(
                        'v1/accounts' => 1,
                        'v1/balance' => 1,
                        'v1/orders' => 1,
                    ),
                    'post' => array(
                        'v1/accounts' => 1,
                        'v1/session/call' => 1,
                    ),
                    'put' => array(
                        'v1/session' => 1,
                    ),
                ),
            ),
            'fees' => array(
                'trading' => array(
                    'tierBased' => false,
                    'percentage' => true,
                    'maker' => $this->parse_number('0.01'),  // 100 basis points = 1%
                    'taker' => $this->parse_number('0.01'),  // 100 basis points = 1%
                ),
            ),
            'requiredCredentials' => array(
                'apiKey' => false,
                'secret' => false,
                'walletAddress' => true,
                'privateKey' => true,
            ),
            'precisionMode' => TICK_SIZE,
            'exceptions' => array(
                'exact' => array(
                ),
                'broad' => array(
                ),
            ),
            'options' => array(
                'sandboxMode' => false,
            ),
        ));
    }

    public function fetch_markets($params = array ()): PromiseInterface {
        return Async\async(function () use ($params) {
            /**
             * retrieves data on all $markets for o2exchange
             * @param {array} [$params] extra parameters specific to the exchange API endpoint
             * @return {array[]} an array of objects representing $market data
             */
            $response = Async\await($this->publicGetV1Markets ($params));
            //
            //     {
            //         "books_registry_id" => "0x...",
            //         "accounts_registry_id" => "0x...",
            //         "trade_account_oracle_id" => "0x...",
            //         "markets" => array(
            //             {
            //                 "contract_id" => "0x...",
            //                 "market_id" => "0x...",
            //                 "maker_fee" => "100",        // basis points (100 = 1%)
            //                 "taker_fee" => "100",        // basis points (100 = 1%)
            //                 "min_order" => "1000000000", // raw units (divide by 10^decimals)
            //                 "dust" => "1000",
            //                 "price_window" => "0",
            //                 "base" => array(
            //                     "symbol" => "ETH",
            //                     "asset" => "0x...",
            //                     "decimals" => 9,
            //                     "max_precision" => 3
            //                 ),
            //                 "quote" => {
            //                     "symbol" => "USDC",
            //                     "asset" => "0x...",
            //                     "decimals" => 9,
            //                     "max_precision" => 2
            //                 }
            //             }
            //         )
            //     }
            //
            $markets = $this->safe_list($response, 'markets', array());
            $result = array();
            for ($i = 0; $i < count($markets); $i++) {
                $market = $markets[$i];
                $result[] = $this->parse_market($market);
            }
            return $result;
        }) ();
    }

    public function parse_market(array $market): array {
        $baseInfo = $this->safe_dict($market, 'base', array());
        $quoteInfo = $this->safe_dict($market, 'quote', array());
        $baseId = $this->safe_string($baseInfo, 'symbol');
        $quoteId = $this->safe_string($quoteInfo, 'symbol');
        $base = $this->safe_currency_code($baseId);
        $quote = $this->safe_currency_code($quoteId);
        $symbol = $base . '/' . $quote;
        $marketId = $this->safe_string($market, 'market_id');
        $basePrecision = $this->safe_integer($baseInfo, 'max_precision', 8);
        $quotePrecision = $this->safe_integer($quoteInfo, 'max_precision', 6);
        $baseDecimals = $this->safe_integer($baseInfo, 'decimals', 9);
        $makerFeeRaw = $this->safe_string($market, 'maker_fee', '0');
        $takerFeeRaw = $this->safe_string($market, 'taker_fee', '0');
        // Fees are in basis points (100 = 1%), convert to decimal
        $makerFee = Precise::string_div($makerFeeRaw, '10000');
        $takerFee = Precise::string_div($takerFeeRaw, '10000');
        // min_order is in raw units, convert using $base decimals
        $minOrderRaw = $this->safe_string($market, 'min_order', '0');
        $baseDecimalsDivisor = '1' . '0'.repeat ($baseDecimals);
        $minOrder = Precise::string_div($minOrderRaw, $baseDecimalsDivisor);
        return $this->safe_market_structure(array(
            'id' => $marketId,
            'symbol' => $symbol,
            'base' => $base,
            'quote' => $quote,
            'baseId' => $baseId,
            'quoteId' => $quoteId,
            'active' => true,
            'type' => 'spot',
            'spot' => true,
            'margin' => false,
            'swap' => false,
            'future' => false,
            'option' => false,
            'contract' => false,
            'settle' => null,
            'settleId' => null,
            'contractSize' => null,
            'linear' => null,
            'inverse' => null,
            'expiry' => null,
            'expiryDatetime' => null,
            'strike' => null,
            'optionType' => null,
            'taker' => $this->parse_number($takerFee),
            'maker' => $this->parse_number($makerFee),
            'percentage' => true,
            'tierBased' => false,
            'feeSide' => 'get',
            'precision' => array(
                'amount' => (string) $this->parse_number($this->parse_precision($basePrecision)),
                'price' => (string) $this->parse_number($this->parse_precision($quotePrecision)),
            ),
            'limits' => array(
                'amount' => array(
                    'min' => $this->parse_number($minOrder),
                    'max' => null,
                ),
                'price' => array(
                    'min' => null,
                    'max' => null,
                ),
                'cost' => array(
                    'min' => null,
                    'max' => null,
                ),
                'leverage' => array(
                    'min' => null,
                    'max' => null,
                ),
            ),
            'created' => null,
            'info' => $market,
        ));
    }

    public function sign(string $path, $api = 'public', $method = 'GET', $params = array (), mixed $headers = null, mixed $body = null) {
        $url = $this->implode_hostname($this->urls['api'][$api]) . '/' . $path;
        if ($method === 'GET') {
            if ($params) {
                $url .= '?' . $this->urlencode($params);
            }
        }
        if ($method === 'POST' || $method === 'PUT') {
            $headers = array(
                'Content-Type' => 'application/json',
            );
            $body = $this->json($params);
        }
        return array( 'url' => $url, 'method' => $method, 'body' => $body, 'headers' => $headers );
    }
}
