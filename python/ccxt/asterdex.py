# -*- coding: utf-8 -*-

# PLEASE DO NOT EDIT THIS FILE, IT IS GENERATED AND WILL BE OVERWRITTEN:
# https://github.com/ccxt/ccxt/blob/master/CONTRIBUTING.md#how-to-contribute-code

from ccxt.base.exchange import Exchange
from ccxt.abstract.asterdex import ImplicitAPI
from ccxt.base.types import Int, Str, Strings, OrderBook, Order, OrderSide, OrderType, Ticker, Tickers, Trade, Balances, Position
from typing import List, Optional
from ccxt.base.errors import ExchangeError, ArgumentsRequired, InsufficientFunds, OrderNotFound, InvalidOrder, DDoSProtection, InvalidNonce, AuthenticationError, RateLimitExceeded, PermissionDenied, NotSupported, BadRequest, BadSymbol, RequestTimeout
from ccxt.base.decimal_to_precision import TICK_SIZE, TRUNCATE
from ccxt.base.precise import Precise
import math


class asterdex(Exchange, ImplicitAPI):

    def describe(self):
        return self.deep_extend(super(asterdex, self).describe(), {
            'id': 'asterdex',
            'name': 'AsterDEX',
            'countries': [],
            'rateLimit': 50,
            'certified': False,
            'pro': False,
            'has': {
                'CORS': None,
                'spot': True,
                'margin': False,
                'swap': True,
                'future': True,
                'option': False,
                'addMargin': True,
                'cancelAllOrders': True,
                'cancelOrder': True,
                'cancelOrders': True,
                'createLimitBuyOrder': True,
                'createLimitSellOrder': True,
                'createMarketBuyOrder': True,
                'createMarketBuyOrderWithCost': True,
                'createMarketOrderWithCost': True,
                'createMarketSellOrder': True,
                'createMarketSellOrderWithCost': True,
                'createOrder': True,
                'createOrders': True,
                'createPostOnlyOrder': True,
                'createReduceOnlyOrder': True,
                'createStopLimitOrder': True,
                'createStopLossOrder': True,
                'createStopMarketOrder': True,
                'createStopOrder': True,
                'createTakeProfitOrder': True,
                'editOrder': False,
                'fetchBalance': True,
                'fetchBidsAsks': True,
                'fetchCanceledOrders': 'emulated',
                'fetchClosedOrders': 'emulated',
                'fetchCurrencies': False,
                'fetchDeposits': False,
                'fetchFundingHistory': True,
                'fetchFundingRate': True,
                'fetchFundingRateHistory': True,
                'fetchFundingRates': True,
                'fetchIndexOHLCV': True,
                'fetchLeverage': False,
                'fetchLeverages': False,
                'fetchLeverageTiers': True,
                'fetchMarginMode': False,
                'fetchMarginModes': False,
                'fetchMarketLeverageTiers': 'emulated',
                'fetchMarkets': True,
                'fetchMarkOHLCV': True,
                'fetchMarkPrice': True,
                'fetchMarkPrices': True,
                'fetchMyTrades': True,
                'fetchOHLCV': True,
                'fetchOpenInterest': False,
                'fetchOpenInterestHistory': False,
                'fetchOpenOrder': True,
                'fetchOpenOrders': True,
                'fetchOrder': True,
                'fetchOrderBook': True,
                'fetchOrders': True,
                'fetchPosition': True,
                'fetchPositionMode': True,
                'fetchPositions': True,
                'fetchPositionsRisk': True,
                'fetchPremiumIndexOHLCV': True,
                'fetchStatus': True,
                'fetchTicker': True,
                'fetchTickers': True,
                'fetchTime': True,
                'fetchTrades': True,
                'fetchTradingFee': False,
                'fetchTradingFees': False,
                'fetchTransfer': False,
                'fetchTransfers': False,
                'fetchWithdrawals': False,
                'reduceMargin': True,
                'setLeverage': True,
                'setMarginMode': True,
                'setPositionMode': True,
                'transfer': True,
                'withdraw': False,
            },
            'timeframes': {
                '1m': '1m',
                '3m': '3m',
                '5m': '5m',
                '15m': '15m',
                '30m': '30m',
                '1h': '1h',
                '2h': '2h',
                '4h': '4h',
                '6h': '6h',
                '8h': '8h',
                '12h': '12h',
                '1d': '1d',
                '3d': '3d',
                '1w': '1w',
                '1M': '1M',
            },
            'urls': {
                'logo': 'https://www.asterdex.com/logo.png',
                'api': {
                    'fapiPublic': 'https://fapi.asterdex.com/fapi/v3',
                    'fapiPrivate': 'https://fapi.asterdex.com/fapi/v3',
                    'sapiPublic': 'https://sapi.asterdex.com/api/v1',
                    'sapiPrivate': 'https://sapi.asterdex.com/api/v1',
                    'public': 'https://sapi.asterdex.com/api/v1',
                    'private': 'https://sapi.asterdex.com/api/v1',
                },
                'www': 'https://www.asterdex.com',
                'doc': [
                    'https://docs.asterdex.com/product/aster-perpetual-pro/api/api-documentation',
                    'https://github.com/asterdex/api-docs',
                ],
                'referral': '',
            },
            'api': {
                # Futures API endpoints
                'fapiPublic': {
                    'get': {
                        'ping': 1,
                        'time': 1,
                        'exchangeInfo': 1,
                        'depth': 1,
                        'trades': 1,
                        'historicalTrades': 1,
                        'aggTrades': 1,
                        'klines': 1,
                        'indexPriceKlines': 1,
                        'markPriceKlines': 1,
                        'premiumIndex': 1,
                        'fundingRate': 1,
                        'ticker/24hr': 1,
                        'ticker/price': 1,
                        'ticker/bookTicker': 1,
                    },
                },
                'fapiPrivate': {
                    'get': {
                        'positionSide/dual': 1,
                        'multiAssetsMargin': 1,
                        'order': 1,
                        'openOrder': 1,
                        'openOrders': 1,
                        'allOrders': 1,
                        'balance': 1,
                        'account': 1,
                        'positionRisk': 1,
                        'userTrades': 1,
                        'income': 1,
                        'leverageBracket': 1,
                        'adlQuantile': 1,
                        'forceOrders': 1,
                        'commissionRate': 1,
                        'positionMargin/history': 1,
                    },
                    'post': {
                        'positionSide/dual': 1,
                        'multiAssetsMargin': 1,
                        'order': 1,
                        'batchOrders': 1,
                        'countdownCancelAll': 1,
                        'leverage': 1,
                        'marginType': 1,
                        'positionMargin': 1,
                        'transfer': 1,
                        'listenKey': 1,
                    },
                    'put': {
                        'listenKey': 1,
                    },
                    'delete': {
                        'order': 1,
                        'allOpenOrders': 1,
                        'batchOrders': 1,
                        'listenKey': 1,
                    },
                },
                # Spot API endpoints
                'sapiPublic': {
                    'get': {
                        'ping': 1,
                        'time': 1,
                        'exchangeInfo': 1,
                        'depth': 1,
                        'trades': 1,
                        'historicalTrades': 1,
                        'aggTrades': 1,
                        'klines': 1,
                        'ticker/24hr': 1,
                        'ticker/price': 1,
                        'ticker/bookTicker': 1,
                        'asset/withdraw-fee': 1,
                        'account/nonce': 1,
                    },
                },
                'sapiPrivate': {
                    'get': {
                        'order': 1,
                        'openOrders': 1,
                        'allOrders': 1,
                        'account': 1,
                        'myTrades': 1,
                    },
                    'post': {
                        'order': 1,
                        'transfer': 1,
                        'withdraw': 1,
                        'account/apikey': 1,
                        'listenKey': 1,
                    },
                    'put': {
                        'listenKey': 1,
                    },
                    'delete': {
                        'order': 1,
                        'openOrders': 1,
                        'listenKey': 1,
                    },
                },
                'public': {
                    'get': {
                        'ping': 1,
                        'time': 1,
                        'exchangeInfo': 1,
                        'depth': 1,
                        'trades': 1,
                        'historicalTrades': 1,
                        'aggTrades': 1,
                        'klines': 1,
                        'ticker/24hr': 1,
                        'ticker/price': 1,
                        'ticker/bookTicker': 1,
                    },
                },
                'private': {
                    'get': {
                        'order': 1,
                        'openOrders': 1,
                        'allOrders': 1,
                        'account': 1,
                        'myTrades': 1,
                    },
                    'post': {
                        'order': 1,
                        'transfer': 1,
                    },
                    'delete': {
                        'order': 1,
                        'openOrders': 1,
                    },
                },
            },
            'fees': {
                'trading': {
                    'tierBased': False,
                    'percentage': True,
                    'maker': self.parse_number('0.0002'),
                    'taker': self.parse_number('0.0005'),
                },
            },
            'requiredCredentials': {
                'apiKey': False,
                'secret': False,
                'walletAddress': True,    # Main account wallet address(user)
                'privateKey': True,        # Signer private key for ECDSA signatures
            },
            'exceptions': {
                'exact': {
                    '-1000': ExchangeError,  # UNKNOWN
                    '-1001': ExchangeError,  # DISCONNECTED
                    '-1002': AuthenticationError,  # UNAUTHORIZED
                    '-1003': RateLimitExceeded,  # TOO_MANY_REQUESTS
                    '-1006': ExchangeError,  # UNEXPECTED_RESP
                    '-1007': RequestTimeout,  # TIMEOUT
                    '-1013': InvalidOrder,  # INVALID_MESSAGE
                    '-1014': InvalidOrder,  # UNKNOWN_ORDER_COMPOSITION
                    '-1015': RateLimitExceeded,  # TOO_MANY_ORDERS
                    '-1016': ExchangeError,  # SERVICE_SHUTTING_DOWN
                    '-1020': InvalidOrder,  # UNSUPPORTED_OPERATION
                    '-1021': InvalidNonce,  # INVALID_TIMESTAMP
                    '-1022': AuthenticationError,  # INVALID_SIGNATURE
                    '-1100': InvalidOrder,  # ILLEGAL_CHARS
                    '-1101': InvalidOrder,  # TOO_MANY_PARAMETERS
                    '-1102': InvalidOrder,  # MANDATORY_PARAM_EMPTY_OR_MALFORMED
                    '-1103': InvalidOrder,  # UNKNOWN_PARAM
                    '-1104': InvalidOrder,  # UNREAD_PARAMETERS
                    '-1105': InvalidOrder,  # PARAM_EMPTY
                    '-1106': InvalidOrder,  # PARAM_NOT_REQUIRED
                    '-1111': BadRequest,  # BAD_PRECISION
                    '-1112': InvalidOrder,  # NO_DEPTH
                    '-1114': InvalidOrder,  # TIF_NOT_REQUIRED
                    '-1115': InvalidOrder,  # INVALID_TIF
                    '-1116': InvalidOrder,  # INVALID_ORDER_TYPE
                    '-1117': InvalidOrder,  # INVALID_SIDE
                    '-1118': InvalidOrder,  # EMPTY_NEW_CL_ORD_ID
                    '-1119': InvalidOrder,  # EMPTY_ORG_CL_ORD_ID
                    '-1120': BadRequest,  # BAD_INTERVAL
                    '-1121': BadSymbol,  # BAD_SYMBOL
                    '-1125': AuthenticationError,  # INVALID_LISTEN_KEY
                    '-1127': InvalidOrder,  # MORE_THAN_XX_HOURS
                    '-1128': InvalidOrder,  # OPTIONAL_PARAMS_BAD_COMBO
                    '-1130': InvalidOrder,  # INVALID_PARAMETER
                    '-2010': ExchangeError,  # NEW_ORDER_REJECTED
                    '-2011': OrderNotFound,  # CANCEL_REJECTED
                    '-2013': OrderNotFound,  # NO_SUCH_ORDER
                    '-2014': AuthenticationError,  # BAD_API_KEY_FMT
                    '-2015': AuthenticationError,  # REJECTED_MBX_KEY
                    '-2016': ExchangeError,  # NO_TRADING_WINDOW
                    '-2019': InsufficientFunds,  # MARGIN_INSUFFICIENT
                    '-4000': InvalidOrder,  # INVALID_PARAM
                    '-4001': BadRequest,  # BAD_ASSET
                    '-5021': InvalidOrder,  # DUE_TO_SELF_TRADE
                    '-5022': InvalidOrder,  # DUE_TO_IMMEDIATE_TRIGGER
                },
                'broad': {
                    'has no operation privilege': PermissionDenied,
                    'MAX_POSITION': InvalidOrder,
                },
            },
            'precisionMode': TICK_SIZE,
            'options': {
                'defaultType': 'swap',  # 'spot', 'swap', 'future'
                'defaultSubType': 'linear',
                'recvWindow': 50000,  # 50 seconds window
                'timeDifference': 0,
                'adjustForTimeDifference': False,
                'parseOrderToPrecision': False,
                'newOrderRespType': 'RESULT',  # or 'ACK', 'FULL'
            },
        })

    def nonce(self):
        # AsterDEX uses microsecond precision for nonce
        return math.trunc(self.milliseconds() * 1000)

    def encode_message(self, params, user, signer, nonce):
        """
        Encode parameters for Web3-style signing
        """
        # Convert params to JSON string(sorted keys, no whitespace)
        params_json = self.json(params)

        # Concatenate: paramsJson + user + signer + nonce
        message = params_json + user.lower() + signer.lower() + str(nonce)

        # Hash with keccak256 using ccxt's built-in hash method
        return self.hash(self.encode(message), 'keccak', 'binary')

    def sign_hash(self, hash_bytes, private_key):
        """
        Sign a message hash with ECDSA secp256k1
        """
        # Remove 0x prefix if present
        clean_private_key = private_key.replace('0x', '')

        # Use ccxt's built-in ecdsa method with secp256k1
        signature = self.ecdsa(hash_bytes[-64:], self.encode(clean_private_key)[-32:], 'secp256k1', None)

        return {
            'r': '0x' + signature['r'],
            's': '0x' + signature['s'],
            'v': self.sum(27, signature['v']),
        }

    def create_signature(self, params, user, signer, nonce):
        """
        Create ECDSA signature for AsterDEX authentication
        """
        hash_bytes = self.encode_message(params, user, signer, nonce)
        signature = self.sign_hash(hash_bytes, self.privateKey)

        # Combine r, s, v into single hex string (without 0x prefix for v)
        v = format(signature['v'], '02x')
        combined = signature['r'] + signature['s'][2:] + v

        return combined

    def sign(self, path, api='public', method='GET', params={}, headers=None, body=None):
        is_private = (api == 'private') or (api == 'fapiPrivate') or (api == 'sapiPrivate')

        if api not in self.urls['api']:
            raise NotSupported(self.id + ' does not have URL for ' + api + ' endpoints')

        url = self.urls['api'][api]
        url += '/' + path

        if is_private:
            self.check_required_credentials()

            nonce = self.nonce()
            timestamp = self.milliseconds()
            recv_window = self.safe_integer(self.options, 'recvWindow', 50000)

            # Extend params with timestamp and recvWindow
            extended_params = self.extend({
                'timestamp': timestamp,
                'recvWindow': recv_window,
            }, params)

            # Create signature
            user = self.walletAddress
            signer = self.walletAddress  # If using different signer address, add as credential
            signature = self.create_signature(extended_params, user, signer, nonce)

            # Add authentication parameters
            extended_params['user'] = user
            extended_params['signer'] = signer
            extended_params['nonce'] = nonce
            extended_params['signature'] = signature

            query = self.urlencode(extended_params)

            headers = {
                'Content-Type': 'application/x-www-form-urlencoded',
            }

            if (method == 'GET') or (method == 'DELETE'):
                url += '?' + query
            else:
                body = query
        else:
            if params:
                url += '?' + self.urlencode(params)

        return {'url': url, 'method': method, 'body': body, 'headers': headers}
