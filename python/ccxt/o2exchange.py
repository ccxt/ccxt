# -*- coding: utf-8 -*-

# PLEASE DO NOT EDIT THIS FILE, IT IS GENERATED AND WILL BE OVERWRITTEN:
# https://github.com/ccxt/ccxt/blob/master/CONTRIBUTING.md#how-to-contribute-code

from ccxt.base.exchange import Exchange
from ccxt.abstract.o2exchange import ImplicitAPI
from ccxt.base.types import Any, Market
from typing import List
from ccxt.base.decimal_to_precision import TICK_SIZE
from ccxt.base.precise import Precise


class o2exchange(Exchange, ImplicitAPI):

    def describe(self) -> Any:
        return self.deep_extend(super(o2exchange, self).describe(), {
            'id': 'o2exchange',
            'name': 'O2 Exchange',
            'countries': ['US'],
            'version': 'v1',
            'rateLimit': 100,
            'certified': False,
            'pro': False,
            'dex': True,
            'has': {
                'CORS': None,
                'spot': True,
                'margin': False,
                'swap': False,
                'future': False,
                'option': False,
                # Public API
                'fetchMarkets': True,
                'fetchTicker': True,
                'fetchTickers': False,
                'fetchOrderBook': True,
                'fetchTrades': True,
                'fetchOHLCV': True,
                # Private API(to implement later)
                'fetchBalance': False,
                'createOrder': False,
                'cancelOrder': False,
                'fetchOpenOrders': False,
                'fetchClosedOrders': False,
                'fetchMyTrades': False,
            },
            'timeframes': {
                '1m': '1',
                '5m': '5',
                '15m': '15',
                '30m': '30',
                '1h': '60',
                '4h': '240',
                '1d': '1440',
            },
            'urls': {
                'logo': 'https://o2.app/logo.png',
                'api': {
                    'public': 'https://api.o2.app',
                    'private': 'https://api.o2.app',
                },
                'test': {
                    'public': 'https://api.testnet.o2.app',
                    'private': 'https://api.testnet.o2.app',
                },
                'www': 'https://o2.app',
                'doc': [
                    'https://docs.o2.app',
                ],
            },
            'api': {
                'public': {
                    'get': {
                        'v1/markets': 1,
                        'v1/markets/summary': 1,
                        'v1/markets/ticker': 1,
                        'v1/depth': 1,
                        'v1/trades': 1,
                        'v1/bars': 1,
                        'health': 1,
                    },
                },
                'private': {
                    'get': {
                        'v1/accounts': 1,
                        'v1/balance': 1,
                        'v1/orders': 1,
                    },
                    'post': {
                        'v1/accounts': 1,
                        'v1/session/call': 1,
                    },
                    'put': {
                        'v1/session': 1,
                    },
                },
            },
            'fees': {
                'trading': {
                    'tierBased': False,
                    'percentage': True,
                    'maker': self.parse_number('0.01'),  # 100 basis points = 1%
                    'taker': self.parse_number('0.01'),  # 100 basis points = 1%
                },
            },
            'requiredCredentials': {
                'apiKey': False,
                'secret': False,
                'walletAddress': True,
                'privateKey': True,
            },
            'precisionMode': TICK_SIZE,
            'exceptions': {
                'exact': {
                },
                'broad': {
                },
            },
            'options': {
                'sandboxMode': False,
            },
        })

    def fetch_markets(self, params={}) -> List[Market]:
        """
        retrieves data on all markets for o2exchange
        :param dict [params]: extra parameters specific to the exchange API endpoint
        :returns dict[]: an array of objects representing market data
        """
        response = self.publicGetV1Markets(params)
        #
        #     {
        #         "books_registry_id": "0x...",
        #         "accounts_registry_id": "0x...",
        #         "trade_account_oracle_id": "0x...",
        #         "markets": [
        #             {
        #                 "contract_id": "0x...",
        #                 "market_id": "0x...",
        #                 "maker_fee": "100",        # basis points(100 = 1%)
        #                 "taker_fee": "100",        # basis points(100 = 1%)
        #                 "min_order": "1000000000",  # raw units(divide by 10^decimals)
        #                 "dust": "1000",
        #                 "price_window": "0",
        #                 "base": {
        #                     "symbol": "ETH",
        #                     "asset": "0x...",
        #                     "decimals": 9,
        #                     "max_precision": 3
        #                 },
        #                 "quote": {
        #                     "symbol": "USDC",
        #                     "asset": "0x...",
        #                     "decimals": 9,
        #                     "max_precision": 2
        #                 }
        #             }
        #         ]
        #     }
        #
        markets = self.safe_list(response, 'markets', [])
        result = []
        for i in range(0, len(markets)):
            market = markets[i]
            result.append(self.parse_market(market))
        return result

    def parse_market(self, market: dict) -> Market:
        baseInfo = self.safe_dict(market, 'base', {})
        quoteInfo = self.safe_dict(market, 'quote', {})
        baseId = self.safe_string(baseInfo, 'symbol')
        quoteId = self.safe_string(quoteInfo, 'symbol')
        base = self.safe_currency_code(baseId)
        quote = self.safe_currency_code(quoteId)
        symbol = base + '/' + quote
        marketId = self.safe_string(market, 'market_id')
        basePrecision = self.safe_integer(baseInfo, 'max_precision', 8)
        quotePrecision = self.safe_integer(quoteInfo, 'max_precision', 6)
        baseDecimals = self.safe_integer(baseInfo, 'decimals', 9)
        makerFeeRaw = self.safe_string(market, 'maker_fee', '0')
        takerFeeRaw = self.safe_string(market, 'taker_fee', '0')
        # Fees are in basis points(100 = 1%), convert to decimal
        makerFee = Precise.string_div(makerFeeRaw, '10000')
        takerFee = Precise.string_div(takerFeeRaw, '10000')
        # min_order is in raw units, convert using base decimals
        minOrderRaw = self.safe_string(market, 'min_order', '0')
        baseDecimalsDivisor = '1' + '0'.repeat(baseDecimals)
        minOrder = Precise.string_div(minOrderRaw, baseDecimalsDivisor)
        return self.safe_market_structure({
            'id': marketId,
            'symbol': symbol,
            'base': base,
            'quote': quote,
            'baseId': baseId,
            'quoteId': quoteId,
            'active': True,
            'type': 'spot',
            'spot': True,
            'margin': False,
            'swap': False,
            'future': False,
            'option': False,
            'contract': False,
            'settle': None,
            'settleId': None,
            'contractSize': None,
            'linear': None,
            'inverse': None,
            'expiry': None,
            'expiryDatetime': None,
            'strike': None,
            'optionType': None,
            'taker': self.parse_number(takerFee),
            'maker': self.parse_number(makerFee),
            'percentage': True,
            'tierBased': False,
            'feeSide': 'get',
            'precision': {
                'amount': str(self.parse_number(self.parse_precision(basePrecision))),
                'price': str(self.parse_number(self.parse_precision(quotePrecision))),
            },
            'limits': {
                'amount': {
                    'min': self.parse_number(minOrder),
                    'max': None,
                },
                'price': {
                    'min': None,
                    'max': None,
                },
                'cost': {
                    'min': None,
                    'max': None,
                },
                'leverage': {
                    'min': None,
                    'max': None,
                },
            },
            'created': None,
            'info': market,
        })

    def sign(self, path: str, api='public', method='GET', params={}, headers: Any = None, body: Any = None):
        url = self.implode_hostname(self.urls['api'][api]) + '/' + path
        if method == 'GET':
            if params:
                url += '?' + self.urlencode(params)
        if method == 'POST' or method == 'PUT':
            headers = {
                'Content-Type': 'application/json',
            }
            body = self.json(params)
        return {'url': url, 'method': method, 'body': body, 'headers': headers}
